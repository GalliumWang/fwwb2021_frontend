var lineData = {
    "type": "FeatureCollection",
    "features": [
      {
        "type": "Feature",
        "properties": {
          "name": "1",
          "url": "http://web.mta.info/nyct/service/",
          "rt_symbol": "1",
          "objectid": "753",
          "id": "2000393",
          "shape_len": "2438.20024902"
        },
        "geometry": {
          "type": "LineString",
          "coordinates": [
            // dist10  7-stations
            [
                120.130134,30.182387
            ],
            [
                120.142638,30.17708
            ],
            [
                120.155789,30.183636
            ],
            [
                120.166425,30.187507
            ],
            [
                120.175193,30.19119
            ],
            [
                120.17972,30.186883
            ],
            [
                120.181445,30.176393
            ],
            //dist5  11-stations
            [
                120.180151,30.169275
            ],
            [
                120.180439,30.159783
            ],
            [
                120.180008,30.147043
            ],
            [
                120.190787,30.142171
            ],
            [
                120.208322,30.152539
            ],
            [
                120.227438,30.16428
            ],
            [
                120.23908,30.154288
            ],
            [
                120.248854,30.149666
            ],
            [
                120.246698,30.124805
            ],
            [
                120.225426,30.11231
            ],
            [
                120.195818,30.094939
            ],
            // dist8  3-stations
            [
                120.175624,30.062001
            ],
            [
                120.165894,30.113621
            ],
            [
                120.113389,30.11937
            ],
            // dist1  1-stations
            [
                120.093925,30.148857
            ],
            // dist6  5-stations
            [
                120.084931,30.159846
            ],
            [
                120.09413,30.16709
            ],
            [
                120.102178,30.176331
            ],
            [
                120.103903,30.165341
            ],
            [
                120.098154,30.155349
            ],
            // dist1  1-station
            [
                120.101029,30.144357
            ],
            // dist5  1-station
            [
                120.124025,30.136612
            ],
          ]
        }
      }
    ]
  };
  
  //stop data
  var stops = {
    "type": "FeatureCollection",
    "features": [    
      {
        "type": "Feature",
        "properties": {
          "name": "Astor Pl",
          "line": "4-6-6 Express",
          "url": "http://web.mta.info/nyct/service/",
          "objectid": "1",
          "notes": "4 nights, 6-all times, 6 Express-weekdays AM southbound, PM northbound"
        },
        "geometry": {
          "type": "Point",
          "coordinates": [
            120.196821,
            30.177019
          ]
        }
      },
      {
        "type": "Feature",
        "properties": {
          "name": "Canal St",
          "line": "4-6-6 Express",
          "url": "http://web.mta.info/nyct/service/",
          "objectid": "2",
          "notes": "4 nights, 6-all times, 6 Express-weekdays AM southbound, PM northbound"
        },
        "geometry": {
          "type": "Point",
          "coordinates":[
            120.182488,
            30.177183
          ]
        }
      },
      {
        "type": "Feature",
        "properties": {
          "name": "Canal St",
          "line": "4-6-6 Express",
          "url": "http://web.mta.info/nyct/service/",
          "objectid": "2",
          "notes": "4 nights, 6-all times, 6 Express-weekdays AM southbound, PM northbound"
        },
        "geometry": {
          "type": "Point",
          "coordinates":[
            120.174551,
            30.177559
          ]
        }
      },
      {
        "type": "Feature",
        "properties": {
          "name": "Canal St",
          "line": "4-6-6 Express",
          "url": "http://web.mta.info/nyct/service/",
          "objectid": "2",
          "notes": "4 nights, 6-all times, 6 Express-weekdays AM southbound, PM northbound"
        },
        "geometry": {
          "type": "Point",
          "coordinates":[
            120.149576,
            30.181256
          ]
        }
      },
      {
        "type": "Feature",
        "properties": {
          "name": "Canal St",
          "line": "4-6-6 Express",
          "url": "http://web.mta.info/nyct/service/",
          "objectid": "2",
          "notes": "4 nights, 6-all times, 6 Express-weekdays AM southbound, PM northbound"
        },
        "geometry": {
          "type": "Point",
          "coordinates":[
            120.136105,
            30.186648
          ]
        }
      },
      {
        "type": "Feature",
        "properties": {
          "name": "Canal St",
          "line": "4-6-6 Express",
          "url": "http://web.mta.info/nyct/service/",
          "objectid": "2",
          "notes": "4 nights, 6-all times, 6 Express-weekdays AM southbound, PM northbound"
        },
        "geometry": {
          "type": "Point",
          "coordinates":[
            120.112519,
            30.186768
          ]
        }
      },
      {
        "type": "Feature",
        "properties": {
          "name": "Canal St",
          "line": "4-6-6 Express",
          "url": "http://web.mta.info/nyct/service/",
          "objectid": "2",
          "notes": "4 nights, 6-all times, 6 Express-weekdays AM southbound, PM northbound"
        },
        "geometry": {
          "type": "Point",
          "coordinates":[
            120.092044,
            30.175170
          ]
        }
      },
      {
        "type": "Feature",
        "properties": {
          "name": "Canal St",
          "line": "4-6-6 Express",
          "url": "http://web.mta.info/nyct/service/",
          "objectid": "2",
          "notes": "4 nights, 6-all times, 6 Express-weekdays AM southbound, PM northbound"
        },
        "geometry": {
          "type": "Point",
          "coordinates":[
              120.076355,
              30.184764
          ]
        }
      },
      {
        "type": "Feature",
        "properties": {
          "name": "Canal St",
          "line": "4-6-6 Express",
          "url": "http://web.mta.info/nyct/service/",
          "objectid": "2",
          "notes": "4 nights, 6-all times, 6 Express-weekdays AM southbound, PM northbound"
        },
        "geometry": {
          "type": "Point",
          "coordinates":[
            120.070768,
            30.222264
          ]
        }
      },
      {
        "type": "Feature",
        "properties": {
          "name": "Canal St",
          "line": "4-6-6 Express",
          "url": "http://web.mta.info/nyct/service/",
          "objectid": "2",
          "notes": "4 nights, 6-all times, 6 Express-weekdays AM southbound, PM northbound"
        },
        "geometry": {
          "type": "Point",
          "coordinates":[
            120.074389,
            30.234369
          ]
        }
      },
      {
        "type": "Feature",
        "properties": {
          "name": "Canal St",
          "line": "4-6-6 Express",
          "url": "http://web.mta.info/nyct/service/",
          "objectid": "2",
          "notes": "4 nights, 6-all times, 6 Express-weekdays AM southbound, PM northbound"
        },
        "geometry": {
          "type": "Point",
          "coordinates":[
              120.079048,
              30.253903
          ]
        }
      },
      {
        "type": "Feature",
        "properties": {
          "name": "Canal St",
          "line": "4-6-6 Express",
          "url": "http://web.mta.info/nyct/service/",
          "objectid": "2",
          "notes": "4 nights, 6-all times, 6 Express-weekdays AM southbound, PM northbound"
        },
        "geometry": {
          "type": "Point",
          "coordinates":[
            120.072639,
            30.270630
          ]
        }
      },
      {
        "type": "Feature",
        "properties": {
          "name": "Canal St",
          "line": "4-6-6 Express",
          "url": "http://web.mta.info/nyct/service/",
          "objectid": "2",
          "notes": "4 nights, 6-all times, 6 Express-weekdays AM southbound, PM northbound"
        },
        "geometry": {
          "type": "Point",
          "coordinates":[
            120.069270,
            30.286740
          ]
        }
      },
      {
        "type": "Feature",
        "properties": {
          "name": "Canal St",
          "line": "4-6-6 Express",
          "url": "http://web.mta.info/nyct/service/",
          "objectid": "2",
          "notes": "4 nights, 6-all times, 6 Express-weekdays AM southbound, PM northbound"
        },
        "geometry": {
          "type": "Point",
          "coordinates":[
            120.091450,
            30.299341
          ]
        }
      },
      {
        "type": "Feature",
        "properties": {
          "name": "Canal St",
          "line": "4-6-6 Express",
          "url": "http://web.mta.info/nyct/service/",
          "objectid": "2",
          "notes": "4 nights, 6-all times, 6 Express-weekdays AM southbound, PM northbound"
        },
        "geometry": {
          "type": "Point",
          "coordinates":[
            120.106281,
            30.313506
          ]
        }
      },
      {
        "type": "Feature",
        "properties": {
          "name": "Canal St",
          "line": "4-6-6 Express",
          "url": "http://web.mta.info/nyct/service/",
          "objectid": "2",
          "notes": "4 nights, 6-all times, 6 Express-weekdays AM southbound, PM northbound"
        },
        "geometry": {
          "type": "Point",
          "coordinates":[
            120.118878,
            30.339645
          ]
        }
      },
      {
        "type": "Feature",
        "properties": {
          "name": "Canal St",
          "line": "4-6-6 Express",
          "url": "http://web.mta.info/nyct/service/",
          "objectid": "2",
          "notes": "4 nights, 6-all times, 6 Express-weekdays AM southbound, PM northbound"
        },
        "geometry": {
          "type": "Point",
          "coordinates":[
            120.161193,
            30.340026
          ]
        }
      },
      {
        "type": "Feature",
        "properties": {
          "name": "Canal St",
          "line": "4-6-6 Express",
          "url": "http://web.mta.info/nyct/service/",
          "objectid": "2",
          "notes": "4 nights, 6-all times, 6 Express-weekdays AM southbound, PM northbound"
        },
        "geometry": {
          "type": "Point",
          "coordinates":[
            120.179858,
            30.289839
          ]
        }
      },
      {
        "type": "Feature",
        "properties": {
          "name": "Canal St",
          "line": "4-6-6 Express",
          "url": "http://web.mta.info/nyct/service/",
          "objectid": "2",
          "notes": "4 nights, 6-all times, 6 Express-weekdays AM southbound, PM northbound"
        },
        "geometry": {
          "type": "Point",
          "coordinates":[
            120.188515,
            30.245833
          ]
        }
      },
      {
        "type": "Feature",
        "properties": {
          "name": "Canal St",
          "line": "4-6-6 Express",
          "url": "http://web.mta.info/nyct/service/",
          "objectid": "2",
          "notes": "4 nights, 6-all times, 6 Express-weekdays AM southbound, PM northbound"
        },
        "geometry": {
          "type": "Point",
          "coordinates":[
            120.194695,
            30.228200
          ]
        }
      }
    ]
  };
  
  district_data={
    "features": [
      {
        "properties": {
          "fill": "#bf4040",
          "fillOpacity": 0.33,
          "fill-opacity": 0.33,
          "fillColor": "#bf4040",
          "color": "#bf4040",
          "contour": 10,
          "opacity": 0.33,
          "metric": "time"
        },
        "geometry": {
          "coordinates": [
            [
                [
                120.186821,
                30.177019
                ],
                [
                120.077044,
                30.165170
                ],
                [
                120.029270,
                30.276740
                ],
                [
                120.108878,
                30.329645
                ],
                [
                120.151193,
                30.330026
                ],
                [
                120.186821,
                30.167019
                ]
            ]
          ],
          "type": "Polygon"
        },
        "type": "Feature"
      }
    ],
    "type": "FeatureCollection"
  }
  
  
  
  
  
  const colorMap = {
    A: "#0039A6",
    B: "#FF6319",
    G: "#6CBE45",
    J: "#996633",
    L: "#A7A9AC",
    N: "#FCCC0A",
    S: "#808183",
    "1": "#EE352E",
    "4": "#00933C",
    "7": "#B933AD"
  };
  
  const linesMap = {};
  lineData.features.map(
    line => (linesMap[line.properties.name] = line.properties.rt_symbol)
  );
  
  //mapped color for each line
  const colorStops = Object.keys(linesMap).map(key => [
    key,
    colorMap[linesMap[key]]
  ]);
  
  
  var init_point=stops.features[0].geometry.coordinates;
  
  const maxBounds = stops.features.reduce(
    (acc, stop) => {
      const [[swLon, swLat], [neLon, neLat]] = acc;
      const [lon, lat] = stop.geometry.coordinates;
      return [
        [Math.min(swLon, lon), Math.min(swLat, lat)],
        [Math.max(neLon, lon), Math.max(neLat, lat)]
      ];
    },
     [init_point,init_point] // [[-74, 40.7328], [-74, 40.7328]]
  );
  
  //TODO replace with my token
  mapboxgl.accessToken =
    "pk.eyJ1IjoiYnJhZGRhaWx5IiwiYSI6ImNqN21iam90ZzJ3MnEzM3F1anNkNWIydjMifQ.Dez6MhslaJs8ROSplWPSpQ";
  
  
  const MAP_SCALE=4
  const MAP_MARGIN_HON=Math.abs(maxBounds[0][0]-maxBounds[1][0])*MAP_SCALE;
  const MAP_MARGIN_VER=Math.abs(maxBounds[0][1]-maxBounds[1][1])*MAP_SCALE;
  
  
  var map;
  
  if (!mapboxgl.supported()) {
    alert("Your browser does not support Mapbox GL");
  } 
  else {
  
    /**
     * map configuration
     */
    map = new mapboxgl.Map({
      preserveDrawingBuffer:true,
  
      container: "map", // id of the element to serve as map
      // style: "mapbox://styles/mapbox/satellite-v9",
      // style: "mapbox://styles/mapbox/dark-v9",
      // style: "mapbox://styles/mapbox/navigation-preview-day-v4",
      // style: "mapbox://styles/mapbox/navigation-preview-night-v4",
      // style: "mapbox://styles/mapbox/navigation-guidance-day-v4",
      style: "mapbox://styles/mapbox/navigation-guidance-night-v4",
      center: [ (maxBounds[0][0]+maxBounds[1][0])/2 , (maxBounds[0][1]+maxBounds[1][1])/2 ], // center of map
      zoom: 11, // 14 for stops display
      maxBounds: [
        [maxBounds[0][0] - MAP_MARGIN_HON, maxBounds[0][1] - MAP_MARGIN_HON],
        [maxBounds[1][0] + MAP_MARGIN_VER, maxBounds[1][1] + MAP_MARGIN_VER]
      ]
    });
  
  
    map.on("load", function() {
      map.addLayer({
        id: "trips",
        type: "line",
        source: {
          type: "geojson",
          data: lineData
        },
        layout: {
          "line-cap": "round",
          "line-join": "round"
        },
        paint: {
          "line-color": {
            property: "name",
            type: "categorical",
            stops: colorStops
          },
          "line-width": {
            base: 1,
            stops: [[9, 1], [11, 1], [13, 5], [15, 10]]
          }
        }
      });
  
      map.addLayer({
        id: "stations",
        source: {
          type: "geojson",
          data: stops
        },
        type: "circle",
        paint: {
          "circle-radius": {
            base: 1,
            stops: [[9, 0], [12, 0], [13, 5], [15, 10]]
          },
          "circle-color": "white",
          "circle-stroke-color": "black",
          "circle-stroke-width": {
            base: 1,
            stops: [[9, 0], [12, 0], [13, 1], [15, 2]]
          }
        }
      });
  
      map.addLayer({
        id: "stations-label",
        source: "stations",
        type: "symbol",
        paint: {
          "text-color": "white",
          "text-halo-color": "black",
          "text-halo-width": 1,
          "text-halo-blur": 4
        },
        layout: {
          "text-font": ["Open Sans Regular"],
          "text-field": "{name} ({line})",
          "text-size": {
            base: 12,
            stops: [[9, 0], [12, 0], [14, 12], [17, 20]]
          },
          "text-anchor": "right",
          "text-offset": [-1.5, 0]
        }
      });
  
      map.addLayer(
        {
          'id': 'districtLayer',
          'type': 'fill',
          'source': {
            type: "geojson",
            data: district_data
          },
          'layout': {},
          'paint': {
            'fill-color': '#5a3fc0',
            'fill-opacity': 0.3
          }
        },
        'poi-label'
      );
  
  
    });
  
    // if ("geolocation" in navigator) {
    //   navigator.geolocation.getCurrentPosition(
    //     ({ coords: { latitude, longitude } }) => {
    //       map.flyTo({ center: [longitude, latitude], zoom: 14 });
    //     }
    //   );
    // }
  }
  
  
  // add subway icon for use
  map.loadImage('./static/image/EXPERIENCE_JAPAN_PICTOGRAM/png/T_CHIKATETSU.png', function(error, image) {
     if (error) throw error;
     map.addImage('subway_icon', image);
  });
  
  
  
  
  function downloadURI(uri, name) {
    var link = document.createElement("a");
    link.download = name;
    link.href = uri;
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
    delete link;
  }
  
  function capture_screen(){ 
  downloadURI(map.getCanvas().toDataURL(),'screen_capture.png'); 
  }
  
  function get_route_data(value){
    value=parseInt(value);
    var origin=JSON.parse(JSON.stringify(lineData));
    switch (value) {
        case -1:
            break;
        case 0:
            origin.features=[];
            break;
        default:
            origin.features=[origin.features[value-1],];
            break;
    }
    console.log(JSON.stringify(origin));
    return origin;
  }
  
  function get_district_data(value){
    value=parseInt(value);
    var origin=JSON.parse(JSON.stringify(district_data));
    switch (value) {
        case -1:
            break;
        case 0:
            origin.features=[];
            break;
        default:
            origin.features=[origin.features[value-1],];
            break;
    }
    return origin;
  }
  
  params.addEventListener('change', function (e) {
    if (e.target.name === 'route') {
        var value = e.target.value;
        var data=get_route_data(value);
        map.getSource('trips').setData(data);
    } 
    else if (e.target.name === 'district') {
        var value = e.target.value;
        var data=get_district_data(value);
        map.getSource('districtLayer').setData(data);
    }
  });
  